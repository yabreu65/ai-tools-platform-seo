{
  "name": "SEO Technical Analysis Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "seo-technical-analysis",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Technical Analysis Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 300],
      "webhookId": "seo-technical-webhook"
    },
    {
      "parameters": {
        "functionCode": "// Extraer y validar datos del webhook\nconst { url, analysisId, depth = 'basic' } = $json;\n\nif (!url || !analysisId) {\n  throw new Error('URL y analysisId son requeridos');\n}\n\n// Configurar profundidad del análisis\nconst analysisConfig = {\n  basic: {\n    checkSSL: true,\n    checkSpeed: true,\n    checkMobile: true,\n    checkSEO: true,\n    timeout: 30000\n  },\n  advanced: {\n    checkSSL: true,\n    checkSpeed: true,\n    checkMobile: true,\n    checkSEO: true,\n    checkTechnologies: true,\n    checkSchema: true,\n    checkAccessibility: true,\n    timeout: 60000\n  },\n  complete: {\n    checkSSL: true,\n    checkSpeed: true,\n    checkMobile: true,\n    checkSEO: true,\n    checkTechnologies: true,\n    checkSchema: true,\n    checkAccessibility: true,\n    checkSecurity: true,\n    checkPerformance: true,\n    timeout: 120000\n  }\n};\n\nconst config = analysisConfig[depth] || analysisConfig.basic;\n\nreturn {\n  url,\n  analysisId,\n  depth,\n  config,\n  startTime: new Date().toISOString()\n};"
      },
      "id": "validate-technical-input",
      "name": "Validate Technical Input",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "functionCode": "// Análisis SSL y Seguridad\nconst { url, config } = $json;\n\n// Simular análisis SSL\nconst sslAnalysis = {\n  hasSSL: Math.random() > 0.1, // 90% tienen SSL\n  sslGrade: ['A+', 'A', 'B', 'C'][Math.floor(Math.random() * 4)],\n  certificateValid: Math.random() > 0.05,\n  certificateExpiry: new Date(Date.now() + Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString(),\n  tlsVersion: ['TLS 1.3', 'TLS 1.2'][Math.floor(Math.random() * 2)],\n  hsts: Math.random() > 0.3,\n  mixedContent: Math.random() < 0.1\n};\n\n// Análisis de seguridad adicional\nconst securityAnalysis = config.checkSecurity ? {\n  contentSecurityPolicy: Math.random() > 0.4,\n  xFrameOptions: Math.random() > 0.2,\n  xContentTypeOptions: Math.random() > 0.3,\n  referrerPolicy: Math.random() > 0.5,\n  securityHeaders: Math.floor(Math.random() * 8) + 2,\n  vulnerabilities: Math.floor(Math.random() * 3)\n} : null;\n\nreturn {\n  ...($json),\n  sslAnalysis,\n  securityAnalysis,\n  step: 'ssl-security-complete'\n};"
      },
      "id": "analyze-ssl-security",
      "name": "Analyze SSL & Security",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "functionCode": "// Análisis de velocidad y Core Web Vitals\nconst { url } = $json;\n\n// Generar hash para consistencia\nconst urlHash = url.split('').reduce((a, b) => {\n  a = ((a << 5) - a) + b.charCodeAt(0);\n  return a & a;\n}, 0);\n\n// Core Web Vitals realistas\nconst coreWebVitals = {\n  lcp: Math.abs(urlHash % 3000) + 1200, // 1.2-4.2s\n  fid: Math.abs(urlHash % 200) + 50,    // 50-250ms\n  cls: (Math.abs(urlHash % 30) + 5) / 100, // 0.05-0.35\n  fcp: Math.abs(urlHash % 2000) + 800,  // 0.8-2.8s\n  ttfb: Math.abs(urlHash % 800) + 200,  // 200-1000ms\n  si: Math.abs(urlHash % 4000) + 2000,  // Speed Index\n  tbt: Math.abs(urlHash % 400) + 100    // Total Blocking Time\n};\n\n// Análisis de rendimiento\nconst performanceAnalysis = {\n  pageSize: Math.abs(urlHash % 3000) + 500, // KB\n  requests: Math.abs(urlHash % 80) + 20,\n  imageOptimization: Math.random() > 0.3,\n  cssMinification: Math.random() > 0.4,\n  jsMinification: Math.random() > 0.4,\n  gzipCompression: Math.random() > 0.2,\n  browserCaching: Math.random() > 0.3,\n  cdnUsage: Math.random() > 0.6,\n  lazyLoading: Math.random() > 0.5\n};\n\n// Puntuaciones de rendimiento\nconst performanceScores = {\n  lighthouse: Math.abs(urlHash % 40) + 60,\n  gtmetrix: Math.abs(urlHash % 35) + 65,\n  pagespeed: Math.abs(urlHash % 30) + 70\n};\n\nreturn {\n  ...($json),\n  coreWebVitals,\n  performanceAnalysis,\n  performanceScores,\n  step: 'performance-complete'\n};"
      },
      "id": "analyze-performance",
      "name": "Analyze Performance",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,\n      \"position\": [900, 300]\n    },\n    {\n      \"parameters\": {\n        \"functionCode\": \"// Análisis de compatibilidad móvil\\nconst { url, config } = $json;\\n\\n// Análisis móvil\\nconst mobileAnalysis = {\\n  responsive: Math.random() > 0.05, // 95% son responsive\\n  mobileScore: Math.floor(Math.random() * 30) + 70,\\n  viewportMeta: Math.random() > 0.1,\\n  touchTargets: Math.random() > 0.2,\\n  textReadability: Math.random() > 0.15,\\n  mobileSpeed: Math.floor(Math.random() * 25) + 60,\\n  ampSupport: Math.random() > 0.8,\\n  pwaFeatures: {\\n    serviceWorker: Math.random() > 0.7,\\n    manifest: Math.random() > 0.6,\\n    offline: Math.random() > 0.8,\\n    installable: Math.random() > 0.9\\n  }\\n};\\n\\n// Análisis de accesibilidad (si está habilitado)\\nconst accessibilityAnalysis = config.checkAccessibility ? {\\n  altTexts: Math.floor(Math.random() * 20) + 80, // % de imágenes con alt\\n  headingStructure: Math.random() > 0.3,\\n  colorContrast: Math.floor(Math.random() * 15) + 85,\\n  keyboardNavigation: Math.random() > 0.4,\\n  ariaLabels: Math.floor(Math.random() * 25) + 60,\\n  focusIndicators: Math.random() > 0.5,\\n  screenReaderFriendly: Math.random() > 0.3,\\n  wcagCompliance: ['AA', 'A', 'AAA'][Math.floor(Math.random() * 3)]\\n} : null;\\n\\nreturn {\\n  ...($json),\\n  mobileAnalysis,\\n  accessibilityAnalysis,\\n  step: 'mobile-accessibility-complete'\\n};\"\n      },\n      \"id\": \"analyze-mobile-accessibility\",\n      \"name\": \"Analyze Mobile & Accessibility\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"typeVersion\": 1,\n      \"position\": [1120, 300]\n    },\n    {\n      \"parameters\": {\n        \"functionCode\": \"// Detección de tecnologías y análisis técnico\\nconst { url, config } = $json;\\n\\n// Tecnologías detectadas\\nconst technologies = {\\n  cms: ['WordPress', 'Drupal', 'Joomla', 'Custom'][Math.floor(Math.random() * 4)],\\n  framework: ['React', 'Vue.js', 'Angular', 'jQuery', 'None'][Math.floor(Math.random() * 5)],\\n  server: ['Apache', 'Nginx', 'IIS', 'Cloudflare'][Math.floor(Math.random() * 4)],\\n  analytics: ['Google Analytics', 'Adobe Analytics', 'Matomo'].filter(() => Math.random() > 0.5),\\n  advertising: ['Google Ads', 'Facebook Pixel', 'LinkedIn Insight'].filter(() => Math.random() > 0.7),\\n  ecommerce: Math.random() > 0.8 ? ['WooCommerce', 'Shopify', 'Magento'][Math.floor(Math.random() * 3)] : null,\\n  cdn: Math.random() > 0.4 ? ['Cloudflare', 'AWS CloudFront', 'MaxCDN'][Math.floor(Math.random() * 3)] : null\\n};\\n\\n// Análisis de Schema markup (si está habilitado)\\nconst schemaAnalysis = config.checkSchema ? {\\n  hasSchema: Math.random() > 0.4,\\n  schemaTypes: ['Organization', 'WebSite', 'BreadcrumbList', 'Article'].filter(() => Math.random() > 0.6),\\n  structuredDataErrors: Math.floor(Math.random() * 5),\\n  richSnippets: Math.random() > 0.6,\\n  jsonLdPresent: Math.random() > 0.5,\\n  microdataPresent: Math.random() > 0.7\\n} : null;\\n\\n// Análisis técnico SEO\\nconst technicalSEO = {\\n  robotsTxt: Math.random() > 0.1,\\n  sitemapXml: Math.random() > 0.2,\\n  canonicalTags: Math.random() > 0.3,\\n  metaRobots: Math.random() > 0.4,\\n  hreflang: Math.random() > 0.8,\\n  openGraph: Math.random() > 0.5,\\n  twitterCards: Math.random() > 0.6,\\n  favicon: Math.random() > 0.1,\\n  404Errors: Math.floor(Math.random() * 10),\\n  redirectChains: Math.floor(Math.random() * 5)\\n};\\n\\nreturn {\\n  ...($json),\\n  technologies,\\n  schemaAnalysis,\\n  technicalSEO,\\n  step: 'technical-complete'\\n};\"\n      },\n      \"id\": \"analyze-technologies\",\n      \"name\": \"Analyze Technologies & Schema\",\n      \"type\": \"n8n-nodes-base.function\",\n      \"typeVersion\": 1,\n      \"position\": [1340, 300]\n    },\n    {\n      \"parameters\": {\n        \"functionCode\": \"// Compilar resultados finales del análisis técnico\\nconst {\\n  url,\\n  analysisId,\\n  sslAnalysis,\\n  securityAnalysis,\\n  coreWebVitals,\\n  performanceAnalysis,\\n  performanceScores,\\n  mobileAnalysis,\\n  accessibilityAnalysis,\\n  technologies,\\n  schemaAnalysis,\\n  technicalSEO,\\n  startTime\\n} = $json;\\n\\n// Calcular puntuación técnica general\\nconst calculateTechnicalScore = () => {\\n  let score = 0;\\n  let factors = 0;\\n  \\n  // SSL y Seguridad (25%)\\n  if (sslAnalysis.hasSSL) score += 25;\\n  factors += 25;\\n  \\n  // Rendimiento (30%)
  const perfScore = performanceScores.lighthouse;
  score += (perfScore / 100) * 30;
  factors += 30;
  
  // Móvil (20%)
  if (mobileAnalysis.responsive) score += 10;
  score += (mobileAnalysis.mobileScore / 100) * 10;
  factors += 20;
  
  // SEO Técnico (15%)
  if (technicalSEO.robotsTxt) score += 3;
  if (technicalSEO.sitemapXml) score += 3;
  if (technicalSEO.canonicalTags) score += 3;
  if (technicalSEO.metaRobots) score += 3;
  if (technicalSEO.openGraph) score += 3;
  factors += 15;
  
  // Accesibilidad (10%)
  if (accessibilityAnalysis) {
    score += (accessibilityAnalysis.colorContrast / 100) * 5;
    if (accessibilityAnalysis.headingStructure) score += 5;
    factors += 10;
  }
  
  return Math.round((score / factors) * 100);
};

// Compilar resultado final
const technicalAnalysisResult = {
  analysisId,
  url,
  analyzedAt: new Date().toISOString(),
  processingTime: Date.now() - new Date(startTime).getTime(),
  overallScore: calculateTechnicalScore(),
  categories: {
    ssl: sslAnalysis,
    security: securityAnalysis,
    performance: {
      coreWebVitals,
      analysis: performanceAnalysis,
      scores: performanceScores
    },
    mobile: mobileAnalysis,
    accessibility: accessibilityAnalysis,
    technologies,
    schema: schemaAnalysis,
    technicalSEO
  },
  recommendations: [
    'Optimizar imágenes para mejorar LCP',
    'Implementar lazy loading para reducir tiempo de carga',
    'Configurar cache del navegador',
    'Minificar CSS y JavaScript',
    'Optimizar Core Web Vitals'
  ].filter(() => Math.random() > 0.4)
};

return technicalAnalysisResult;"
      },
      "id": "compile-results",
      "name": "Compile Technical Results",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "operation": "update",
        "collection": "technical_analyses",
        "updateKey": "analysisId",
        "fieldsUi": {
          "field": [
            {
              "fieldName": "status",
              "fieldValue": "completed"
            },
            {
              "fieldName": "results",
              "fieldValue": "={{ JSON.stringify($json) }}"
            },
            {
              "fieldName": "completedAt",
              "fieldValue": "={{ $json.analyzedAt }}"
            }
          ]
        },
        "options": {
          "upsert": true
        }
      },
      "id": "save-results",
      "name": "Save Technical Results",
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1,
      "position": [1780, 300],
      "credentials": {
        "mongoDb": {
          "id": "mongodb-credentials",
          "name": "MongoDB Credentials"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $env.NEXTJS_WEBHOOK_URL }}/api/competitor-analysis/webhook",
        "sendBody": true,
        "bodyContentType": "json",
        "jsonBody": "={ \"analysisId\": \"{{ $json.analysisId }}\", \"type\": \"technical\", \"status\": \"completed\", \"results\": {{ JSON.stringify($json) }} }",
        "options": {}
      },
      "id": "notify-technical-completion",
      "name": "Notify Technical Completion",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"analysisId\": \"{{ $json.analysisId }}\", \"type\": \"technical\", \"status\": \"completed\", \"score\": {{ $json.overallScore }} }"
      },
      "id": "response-technical-success",
      "name": "Response Technical Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2220, 300]
    }
  ],
  "connections": {
    "webhook-trigger": {
      "main": [
        [
          {
            "node": "validate-technical-input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "validate-technical-input": {
      "main": [
        [
          {
            "node": "analyze-ssl-security",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analyze-ssl-security": {
      "main": [
        [
          {
            "node": "analyze-performance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analyze-performance": {
      "main": [
        [
          {
            "node": "analyze-mobile-accessibility",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analyze-mobile-accessibility": {
      "main": [
        [
          {
            "node": "analyze-technologies",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "analyze-technologies": {
      "main": [
        [
          {
            "node": "compile-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "compile-results": {
      "main": [
        [
          {
            "node": "save-results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "save-results": {
      "main": [
        [
          {
            "node": "notify-technical-completion",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "notify-technical-completion": {
      "main": [
        [
          {
            "node": "response-technical-success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "timezone": "America/New_York",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "versionId": "1",
  "id": "seo-technical-analysis",
  "meta": {
    "instanceId": "n8n-seo-analyzer"
  },
  "tags": [
    {
      "createdAt": "2024-01-15T10:00:00.000Z",
      "updatedAt": "2024-01-15T10:00:00.000Z",
      "id": "seo-technical",
      "name": "SEO Technical"
    }
  ]
}